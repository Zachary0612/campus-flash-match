version: '3.8'

# 简化版：只部署前后端，使用服务器已有的 PostgreSQL/Redis/RabbitMQ

services:
  # ========== 后端服务 ==========
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    container_name: campus-backend
    restart: unless-stopped
    environment:
      # 数据库配置 - 连接宿主机的 PostgreSQL
      SPRING_DATASOURCE_URL: jdbc:postgresql://host.docker.internal:5432/campus_flash_match
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-campus_user}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      # Redis配置 - 连接宿主机的 Redis
      SPRING_DATA_REDIS_HOST: host.docker.internal
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD:-123456}
      # RabbitMQ配置 - 连接宿主机的 RabbitMQ
      SPRING_RABBITMQ_HOST: host.docker.internal
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-zachary}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-123456}
      # JWT配置
      JWT_SECRET: ${JWT_SECRET:-campus-flash-match-secret-key-with-at-least-64-characters-for-hs512-algorithm-security}
      # 时区
      TZ: Asia/Shanghai
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - uploads_data:/app/uploads
    ports:
      - "8080:8080"
    networks:
      - campus-network

  # ========== 前端服务 ==========
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    container_name: campus-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    networks:
      - campus-network
    depends_on:
      - backend

# ========== 数据卷 ==========
volumes:
  uploads_data:

# ========== 网络 ==========
networks:
  campus-network:
    driver: bridge
