# 校园拼单/约伴系统架构设计

## 一、架构概述

采用经典的分层架构设计，结合模块化思想，将系统分为以下层次：

1. **表现层（Controller）**：处理HTTP请求，参数校验，响应封装
2. **业务层（Service）**：实现核心业务逻辑，事务管理
3. **数据访问层（Mapper/Repository）**：数据库交互，CRUD操作
4. **实体层（Entity）**：数据模型定义，ORM映射
5. **传输层（DTO/VO）**：数据传输对象，前后端交互
6. **基础设施层**：中间件配置、工具类、拦截器等

## 二、模块划分

### 1. 用户模块（User Module）
- 负责用户注册、登录、身份认证
- 校园位置绑定管理
- 用户信用分查询和变更记录

### 2. 事件模块（Event Module）
- 事件创建、查询、匹配
- 事件参与、退出管理
- 事件状态流转（进行中、已满、过期、结算）

### 3. 信标模块（Beacon Module）
- 信标发布和管理
- 信标举报机制
- 信标状态检查

### 4. 信用模块（Credit Module）
- 信用分计算和管理
- 信用记录生成和查询
- 信用规则校验

### 5. 通知模块（Notify Module）
- WebSocket实时通知
- 事件满员/结算消息推送
- 系统提醒

## 三、技术栈配置

### 1. 核心框架
- Spring Boot 2.7.x
- MyBatis-Plus 3.5.x

### 2. 数据库
- PostgreSQL 14.x
  - 表结构：用户表、校园点位表、事件历史表、信用记录表、信标表

### 3. 中间件
- Redis 6.x
  - 缓存：用户信息、事件信息
  - 地理位置：GEO功能用于附近事件查询
  - 分布式锁：保证事件参与并发安全
  - 过期监听：事件过期自动处理
- RabbitMQ 3.9.x
  - 事件结算队列
  - 异步任务处理
- WebSocket
  - 实时通知推送

### 4. 安全与认证
- JWT：用户身份认证
- BCrypt：密码加密
- 拦截器：请求认证、IP校验

## 四、关键设计

### 1. 并发控制
- Redis事务（MULTI/EXEC）：保证事件参与的原子性
- CAS机制：处理并发修改

### 2. 数据一致性
- Spring事务：数据库操作事务管理
- 最终一致性：Redis缓存与数据库同步

### 3. 性能优化
- 缓存策略：热点数据缓存
- 分页查询：大数据量查询优化
- 异步处理：耗时操作异步化

### 4. 扩展性设计
- 模块化：低耦合高内聚的模块设计
- 接口抽象：依赖接口而非实现
- 配置外部化：关键参数配置化